# 運用・トラブルシュート

## Traceログ有効化の手順

### 概念

デフォルトでは、詳細ログ（Heartbeat/Service alive）は出力されません。詳細な診断が必要な場合のみ、Traceログを有効化してください。

### 手順

1. 設定値を変更（`kEnableTraceLogs`フラグを`true`に設定）
2. アプリを再起動
3. ログファイルまたは標準出力で詳細ログが出力されることを確認

### 注意事項

- Traceログは大量のログを生成する可能性があります
- 診断が完了したら、`kEnableTraceLogs`を`false`に戻してください
- ログファイルのサイズを定期的に確認してください

## よくある症状と対処

### 症状1: アプリ終了後もログが出力される（残響）

**確認事項:**
- ログファイルで、アプリ終了時刻以降に`[HEARTBEAT]`や`[SERVICE_CHECK]`が出力されていないか確認
- 終了操作（ウィンドウを閉じる）が正常に完了したか確認

**対処:**
- アプリを完全に終了してください（タスクマネージャーでプロセスを確認）
- 問題が継続する場合は、[検証ドキュメント](../LIFECYCLE_CONTRACT_V2_VERIFICATION.md)に従って再検証してください

### 症状2: ログが出力されない（kEnableTraceLogs=trueの場合）

**確認事項:**
- `kEnableTraceLogs`が`true`に設定されているか確認
- アプリを再起動したか確認
- ログファイルの場所が正しいか確認

**対処:**
- `kEnableTraceLogs`の設定値を再確認
- アプリを完全に再起動
- ログファイルのパスを確認（実装に従う）

### 症状3: ログファイルが肥大化している

**確認事項:**
- `kEnableTraceLogs`が`true`になっていないか確認
- ログファイルのサイズを確認

**対処:**
- `kEnableTraceLogs`を`false`に戻す
- 古いログファイルをアーカイブまたは削除
- ログファイルの保管ルールに従って管理

## ログの保管ルール

### ファイル名規約

ログファイル名は以下の形式です：

```
crash_YYYY-MM-DDTHH-mm-ss.log
```

例: `crash_2024-01-15T14-30-45.log`

### 保管場所

- **Windows**: `%LOCALAPPDATA%\after_app\logs\`（実装に従う）
- **その他**: `getApplicationDocumentsDirectory()/after_app/logs/`（実装に従う）

実装詳細は`crash_logger.dart`の`initialize()`メソッドを参照してください。

### 保管期間

- ログファイルの保管期間は利用者の判断に委ねます
- 定期的なアーカイブまたは削除を推奨します
- 問題発生時は、関連するログファイルを保持してください

## 監査・引き継ぎの観点

### いつ何を見るか

#### 定期的な確認（推奨）

- **ログファイルのサイズ**: 月1回程度、ログファイルのサイズを確認
- **`kEnableTraceLogs`の設定**: 不要な場合は`false`に設定されているか確認

#### 問題発生時

- **ログファイルの確認**: 問題発生時刻前後のログファイルを確認
- **検証ドキュメントの参照**: [検証ドキュメント](../LIFECYCLE_CONTRACT_V2_VERIFICATION.md)に従って動作確認

#### 引き継ぎ時

- **契約(v2)の実装状況**: 実装・検証済みであることを確認
- **設定値の確認**: `kEnableTraceLogs`の設定値を確認
- **ログ保管ルール**: ログファイルの保管場所とルールを確認

### 監査チェックリスト

- [ ] ログファイルが適切に保管されている
- [ ] `kEnableTraceLogs`が適切に設定されている
- [ ] アプリ終了後のログ残響がない
- [ ] ログファイルのサイズが適切な範囲内
